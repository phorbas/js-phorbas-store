<!DOCTYPE html>
<html lang='en'>
<head>
  <meta charset='utf-8' />
  <meta name='viewport' content='width=device-width, initial-scale=1'>
  <title>Phorbas Opaque Websrv Sandbox</title>

  <link rel='icon' href='data:image/png;base64,' />
  <link rel='stylesheet' crossorigin='anonymous' href='https://cdn.jsdelivr.net/npm/hiq@4.1.9/dist/hiq.css' integrity='sha256-lmhDSTOvoVL6vf39JzQIJnJiey65rv7M/AW/2+PDzzs=' />

</head>

<body>
<main class='container'>
  <h1>Console is where it's happen'</h1>
</main>

<script type=module>
  import ky from 'https://cdn.skypack.dev/ky?dts'

  let mime_plain = 'text/plain; charset=UTF-8'
  let _dapi_kinds_ = setup_demo(0 ? 'shared/one' : 'param/other')
  Object.assign(window, {
    ky, demo: _dapi_kinds_, setup_demo,
    do_demo_str, do_demo_json, do_demo_hk21, })

  {
    let dapi = 1 ? _dapi_kinds_.fetch : _dapi_kinds_.ky
    window.demo_str = await do_demo_str(dapi)
    console.log(window.demo_str)

    window.demo_json = await do_demo_json(dapi)
    console.log(window.demo_json)
  }

  function do_demo_str(dapi, str='a plain string demo') {
    let hk21 = dapi.q_set_blob(mime_plain, str)
    return do_demo_hk21(dapi, hk21)
  }

  function do_demo_json(dapi, json={a: 'bingo', b: 1942, c: false}) {
    let hk21 = dapi.q_set_json(json)
    return do_demo_hk21(dapi, hk21)
  }

  async function do_demo_hk21(dapi, hk21) {
    hk21 = await hk21
    //let rt_has = await dapi.q_has(hk21)
    let rt = await dapi.q_get(hk21)
    return {__proto__: dapi, hk21, rt, /*rt_has*/}
  }


  function setup_demo(url_suffix) {
    let url_dest = `http://127.0.0.1:9091/opaque/${url_suffix}`
    return {
      fetch: _with_fetch(url_dest),
      ky: _with_ky(url_dest),
    }
  }

  function _with_fetch(url_dest) {
    return {
      async q_has(hk) {
        hk = await hk
        if (Array.isArray(hk)) hk = hk[1]
        let res = await fetch(new URL(hk, url_dest), {method: 'HEAD', mode: 'cors'})
        return res },
      async q_get(hk) {
        hk = await hk
        if (Array.isArray(hk)) hk = hk[1]
        let res = await fetch(new URL(hk, url_dest), {method: 'GET', mode: 'cors'})
        return res },
      async q_set_json(json) {
        return this.q_set_blob('application/json', JSON.stringify(json)) },
      async q_set_blob(type, body) {
        body = new Blob([body], {type})
        return this.q_set({body}) },
      async q_set(fetch_arg) {
        let res = await fetch(url_dest, {method: 'POST', mode: 'cors', ... fetch_arg})

        let hk2 = res.headers.get('x-hk2')
        let hk1 = res.headers.get('x-hk1')
        return [hk2, hk1] },
    }
  }
  function _with_ky(url_dest) {
    return {
      async q_has(hk) {
        hk = await hk
        if (Array.isArray(hk)) hk = hk[1]
        let res = await ky.head(new URL(hk, url_dest))
        return res },
      async q_get(hk) {
        hk = await hk
        if (Array.isArray(hk)) hk = hk[1]
        let res = await ky.get(new URL(hk, url_dest))
        return res },
      async q_set_json(json) {
        return this.q_set({json}) },
      async q_set_blob(type, body) {
        body = new Blob([body], {type})
        return this.q_set({body}) },
      async q_set(post_arg) {
        let res = await ky.post(url_dest, post_arg)

        let hk2 = res.headers.get('x-hk2')
        let hk1 = res.headers.get('x-hk1')
        return [hk2, hk1] },
    }
  }
</script>
<script src='/livereload.js'></script>
</body>
</html>

